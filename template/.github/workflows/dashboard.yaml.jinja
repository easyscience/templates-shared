name: Dashboard build and publish

on:
  workflow_dispatch:
  workflow_call:

# Allow only one concurrent workflow, skipping runs queued between the run
# in-progress and latest queued. And cancel in-progress runs.
concurrency:
  group:
    {% raw %}${{ github.workflow }}{% endraw %}-{% raw %}${{ github.event.pull_request.number || github.ref }}{% endraw %}
  cancel-in-progress: true

# Set the environment variables to be used in all jobs defined in this workflow
env:
  CI_BRANCH: {% raw %}${{ github.head_ref || github.ref_name }}{% endraw %}
  DEFAULT_BRANCH: {% raw %}${{ github.event.repository.default_branch }}{% endraw %}
  DEVELOP_BRANCH: develop
  REPO_OWNER: {% raw %}${{ github.repository_owner }}{% endraw %}
  REPO_NAME: {% raw %}${{ github.event.repository.name }}{% endraw %}

jobs:
  dashboard:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      # Create GitHub App token for pushing to external dashboard repo.
      # The 'repositories' parameter is required to grant access to repos
      # other than the one where the workflow is running.
      - name: Setup easyscience[bot]
        uses: ./.github/actions/setup-easyscience-bot
        with:
          app-id: {% raw %}${{ vars.EASYSCIENCE_APP_ID }}{% endraw %}
          private-key: {% raw %}${{ secrets.EASYSCIENCE_APP_KEY }}{% endraw %}
          repositories: |
            {% raw %}${{ github.event.repository.name }}{% endraw %}
            dashboard

      - name: Set up pixi
        uses: ./.github/actions/setup-pixi

      - name: Install badgery
        shell: bash
        run: pixi add --pypi --git https://github.com/enhantica/badgery badgery

      - name: Run docstring coverage and code complexity/maintainability checks
        run: |
          for BRANCH in $DEFAULT_BRANCH $DEVELOP_BRANCH $CI_BRANCH; do
            echo
            echo "ðŸ”¹ðŸ”¸ðŸ”¹ðŸ”¸ðŸ”¹ Processing branch $BRANCH ðŸ”¹ðŸ”¸ðŸ”¹ðŸ”¸ðŸ”¹"
            if [ -d "../$BRANCH" ]; then
              echo "Branch $BRANCH already processed, skipping"
              continue
            fi

            git worktree add ../$BRANCH origin/$BRANCH
            mkdir -p reports/$BRANCH

            echo "Docstring coverage for branch $BRANCH"
            pixi run interrogate -c pyproject.toml --fail-under=0 ../$BRANCH/src > reports/$BRANCH/coverage-docstring.txt

            echo "Cyclomatic complexity for branch $BRANCH"
            pixi run radon cc -s -j ../$BRANCH/src > reports/$BRANCH/cyclomatic-complexity.json

            echo "Maintainability index for branch $BRANCH"
            pixi run radon mi -j ../$BRANCH/src > reports/$BRANCH/maintainability-index.json

            echo "Raw metrics for branch $BRANCH"
            pixi run radon raw -s -j ../$BRANCH/src > reports/$BRANCH/raw-metrics.json
          done

      - name: Generate dashboard HTML
        run: >
          pixi run python -m badgery --config .badgery.yaml --repo
          {% raw %}${{ github.repository }}{% endraw %} --branch {% raw %}${{ env.CI_BRANCH }}{% endraw %} --output index.html

      - name: Prepare publish directory
        run: |
          mkdir -p _dashboard_publish/{% raw %}${{ env.REPO_NAME }}{% endraw %}/{% raw %}${{ env.CI_BRANCH }}{% endraw %}
          cp index.html _dashboard_publish/{% raw %}${{ env.REPO_NAME }}{% endraw %}/{% raw %}${{ env.CI_BRANCH }}{% endraw %}

      - name: Publish to main branch of {% raw %}${{ github.repository }}{% endraw %}
        uses: peaceiris/actions-gh-pages@v3
        with:
          external_repository: {% raw %}${{ env.REPO_OWNER }}{% endraw %}/dashboard
          publish_branch: {% raw %}${{ env.DEFAULT_BRANCH }}{% endraw %}
          personal_token: {% raw %}${{ steps.app-token.outputs.token }}{% endraw %}
          publish_dir: ./_dashboard_publish
          keep_files: true

      - name: Add dashboard link to summary
        run: |
          URL="https://{% raw %}${{ env.REPO_OWNER }}{% endraw %}.github.io/dashboard/{% raw %}${{ env.REPO_NAME }}{% endraw %}/{% raw %}${{ env.CI_BRANCH }}{% endraw %}"
          echo "Dashboard link: [$URL]($URL)" >> $GITHUB_STEP_SUMMARY
