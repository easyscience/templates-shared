name: PyPI package tests

on:
  #####################################
  push:
    branches: [ master, main, develop ]
  #####################################
  # Run daily, at 00:00.
  schedule:
    - cron: '0 0 * * *'
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# Allow only one concurrent workflow, skipping runs queued between the run
# in-progress and latest queued. And cancel in-progress runs.
concurrency:
  group:
    {% raw %}${{ github.workflow }}{% endraw %}-{% raw %}${{ github.event.pull_request.number || github.ref }}{% endraw %}
  cancel-in-progress: true

# Set the environment variables to be used in all jobs defined in this workflow
env:
  CI_BRANCH: {% raw %}${{ github.head_ref || github.ref_name }}{% endraw %}
  DEFAULT_BRANCH: {% raw %}${{ github.event.repository.default_branch }}{% endraw %}

jobs:
  # Job 1: Test installation from PyPI on multiple OS
  pypi-package-tests:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    runs-on: {% raw %}${{ matrix.os }}{% endraw %}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Set up pixi
        uses: ./.github/actions/setup-pixi
        with:
          environments: ''
          activate-environment: ''
          run-install: false
          frozen: false

      - name: Init pixi project
        run: pixi init {{ lib_package_name }}

      - name: Add Python {{ lib_python_max }} from Conda
        working-directory: {{ lib_package_name }}
        run: pixi add "python={{ lib_python_max }}"

      - name: Add other Conda dependencies
        working-directory: {{ lib_package_name }}
        run: pixi add gsl

      - name: Add {{ lib_package_name }} from PyPI
        working-directory: {{ lib_package_name }}
        run: pixi add --pypi "{{ lib_package_name }}[all]"

      - name: Add Pixi task as a shortcut
        working-directory: {{ lib_package_name }}
        run: pixi task add {{ lib_package_name }} "python -m {{ lib_package_name }}"

      - name: Run unit tests to verify the installation
        working-directory: {{ lib_package_name }}
        run: pixi run python -m pytest ../tests/unit/ --color=yes -v

      - name: Run integration tests to verify the installation
        working-directory: {{ lib_package_name }}
        run: pixi run python -m pytest ../tests/integration/ --color=yes -n auto

      # Github token to avoid hitting the unauthenticated API rate limit
      - name: List and fetch the {{ lib_package_name }} tutorials
        working-directory: {{ lib_package_name }}
        env:
          GITHUB_TOKEN: {% raw %}${{ secrets.GITHUB_TOKEN }}{% endraw %}
        run: |
          pixi run {{ lib_package_name }} --version
          pixi run {{ lib_package_name }} list-tutorials
          pixi run easydiffraction download-tutorial 1

      - name: Test tutorials as notebooks
        working-directory: {{ lib_package_name }}
        run: pixi run python -m pytest --nbmake tutorials/ --nbmake-timeout=600 --color=yes -n auto -v

  # Job 2: Trigger dashboard build
  #dashboard-build-trigger:
  #  needs: pypi-package-tests

  #  runs-on: ubuntu-latest

  #  steps:
  #    - name: Check-out repository
  #      uses: actions/checkout@v5

  #    - name: Trigger dashboard build
  #      uses: actions/github-script@v7
  #      with:
  #        github-token: {% raw %}${{ secrets.GITHUB_TOKEN }}{% endraw %}
  #        script: |
  #          await github.rest.actions.createWorkflowDispatch({
  #            owner: context.repo.owner,
  #            repo: context.repo.repo,
  #            workflow_id: "dashboard.yaml",
  #            ref: "{% raw %}${{ env.CI_BRANCH }}{% endraw %}"
  #          });
